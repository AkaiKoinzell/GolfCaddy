<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistiche - Golf Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    header {
      background-color: #006400;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      background: #e0e0e0;
      padding: 0.5rem;
      margin-bottom: 2rem;
    }
    nav a {
      text-decoration: none;
      color: #006400;
      font-weight: bold;
    }
    h2 {
      color: #006400;
    }
    .chart-container {
      max-width: 700px;
      margin: 2rem auto;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
    }
    #hcp-value {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>Statistiche Personali</h1>
  </header>
  <nav>
    <a href="home.html">Home</a>
    <a href="index.html">Aggiungi Round</a>
    <a href="stats.html">Statistiche</a>
    <a href="profile.html">Profilo</a>
  </nav>

  <section style="text-align:center;margin:2rem;">
    <div style="font-size:1.2rem;font-weight:bold;">Il tuo Handicap</div>
    <div id="hcp-value">--</div>
    <div style="margin-top:1rem;color:#555;font-size:0.9rem;">
      Calcolato come media dei migliori 8 score differential tra gli ultimi 20 round (WHS).
    </div>
  </section>

  <section style="max-width:800px;margin:2rem auto;">
    <label>Filtra:
      <select id="filter-format">
        <option value="all">Tutti</option>
        <option value="9">9 buche</option>
        <option value="18">18 buche</option>
      </select>
      <select id="filter-course">
        <option value="all">Tutti i campi</option>
      </select>
    </label>
  </section>

  <aside class="chart-container"><h2>Handicap nel tempo</h2><canvas id="hcpChart"></canvas></aside>
  <aside class="chart-container"><h2>% Putt sui colpi totali</h2><canvas id="puttChart"></canvas></aside>

  <section class="chart-container"><h2>Storico Round</h2>
    <table id="rounds-table">
      <thead>
        <tr>
          <th>Data</th><th>Campo</th><th>Format</th><th>Punteggio</th><th>Netto</th><th>Dettagli</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { calculateHandicap } from "./handicap.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2SWQzBCq2M18idSSXS-gR75I7fSV2NXk",
      authDomain: "golfcaddy-ec421.firebaseapp.com",
      projectId: "golfcaddy-ec421",
      storageBucket: "golfcaddy-ec421.firebasestorage.app",
      messagingSenderId: "497160592489",
      appId: "1:497160592489:web:548701ab6d395e579456f8",
      measurementId: "G-XGBVHR0BD5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allRounds = [], filters = { format: 'all', course: 'all' };
    let hcpChart, puttChart;

    async function loadStats() {
      const snap = await getDocs(collection(db, "golf_rounds"));
      allRounds = snap.docs.map(doc => {
        const d = doc.data();
        const date = new Date(d.timestamp);
        const format = d.holes.length <= 9 ? 9 : 18;
        const score = d.holes.reduce((a,h)=>a+h.score,0);
        const par = d.holes.reduce((a,h)=>a+(h.par || 0), 0);
        return {
          id: doc.id,
          course: d.course,
          date,
          format,
          score,
          par,
          holes: d.holes,
          putts: d.holes.reduce((a,h)=>a+(h.putts||0),0),
          courseRating: d.courseRating,
          slopeRating: d.slopeRating,
          combo: d.combo || false
        };
      });

      populateCourseFilter();
      updateDisplay();
    }

    function populateCourseFilter(){
      const sel = document.getElementById('filter-course');
      const courses = [...new Set(allRounds.map(r=>r.course))];
      courses.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      });
      [ 'filter-format','filter-course' ].forEach(id=> {
        document.getElementById(id).addEventListener('change',e=>{
          filters[id==='filter-format'?'format':'course']=e.target.value;
          updateDisplay();
        });
      });
    }

    function updateDisplay() {
      const rounds = allRounds
        .filter(r => (filters.format==='all'||r.format === parseInt(filters.format)))
        .filter(r => (filters.course==='all'||r.course === filters.course))
        .sort((a,b)=>a.date - b.date);

      const validRounds = allRounds.filter(r => r.format === 18 || r.combo);
      const h = calculateHandicap(validRounds);
      document.getElementById('hcp-value').textContent = (typeof h === 'number') ? h.toFixed(1) : '--';

      drawCharts(rounds);
      drawTable(rounds);
    }

    function formatDate(d){
      return d.toLocaleDateString('it-IT');
    }

    function drawTable(rounds) {
      const tbody = document.querySelector('#rounds-table tbody');
      tbody.innerHTML = '';
      rounds.forEach(r=>{
        const netto = (typeof r.par === 'number') ? (r.score - r.par) : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(r.date)}</td>
          <td>${r.course}</td>
          <td>${r.format} buche</td>
          <td>${r.score}</td>
          <td>${netto !== '' ? (netto >= 0 ? '+' + netto : netto) : ''}</td>
          <td><a href="round.html?id=${r.id}">Dettagli</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function drawCharts(rounds) {
      const labels = rounds.map(r=>formatDate(r.date));
      const puttPct = rounds.map(r => ((r.putts/r.score)*100).toFixed(1));

      if(puttChart) puttChart.destroy();
      puttChart = new Chart(document.getElementById('puttChart'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'% Putt', data:puttPct, backgroundColor:'#32CD32' }]},
        options:{ scales:{ y:{ beginAtZero:true, max:100 }}}
      });

      if(hcpChart) hcpChart.destroy();
      const diffs = rounds.map(r=>r.par ? (r.score - r.par) : null);
      hcpChart = new Chart(document.getElementById('hcpChart'),{
        type:'line',
        data:{ labels, datasets:[{ label:'Netto', data:diffs, borderColor:'#006400', fill:false }]},
        options:{ plugins:{ tooltip:{ callbacks:{ label:ctx=>`Netto ${ctx.formattedValue}` }}}}
      });
    }

    loadStats();
  </script>
</body>
</html>
